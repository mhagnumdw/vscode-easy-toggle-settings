name: 'Setup, Test and Package'
description: 'Shared setup, test and package steps'

runs:
  using: composite
  steps:
  - name: Install Node.js
    uses: actions/setup-node@v4
    with:
      node-version-file: .tool-versions

  - name: Install dependencies
    run: npm install
    shell: bash

  - name: Run tests
    run: xvfb-run -a npm run test:coverage
    shell: bash

  - name: ls-la antes
    shell: bash
    run: |
      ls -la

  - name: Update Coverage Badge
    # if: github.ref == format('refs/heads/{0}', github.event.repository.default_branch)
    # if: github.ref_name == github.event.repository.default_branch
    uses: we-cli/coverage-badge-action@main

  - name: Package
    shell: bash
    run: |
      ls -la
      npx vsce ls --tree
      npx vsce package --allow-star-activation

  - uses: actions/upload-artifact@v4
    with:
      name: easy-toggle-settings-artifacts
      path: easy-toggle-settings-*.vsix
      if-no-files-found: error
